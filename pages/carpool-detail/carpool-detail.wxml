<!--pages/carpool-detail/carpool-detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- æ‹¼è½¦è¯¦æƒ… -->
  <view wx:else class="carpool-detail">
    <!-- æ´»åŠ¨ä¿¡æ¯å¡ç‰‡ -->
    <view class="detail-card">
      <view class="card-header">
        <view class="activity-name">{{carpoolDetail.activityName}}</view>
        <view class="status {{carpoolDetail.status === 'æ‹›å‹Ÿä¸­' ? 'recruiting' : 'full'}}">
          {{carpoolDetail.status}}
        </view>
      </view>

      <view class="activity-info">
        <view class="info-row">
          <view class="info-icon">ğŸ“…</view>
          <view class="info-label">æ—¶é—´ï¼š</view>
          <view class="info-value">{{carpoolDetail.departureTime || (carpoolDetail.date + ' ' + carpoolDetail.time)}}</view>
        </view>
        <view class="info-row" bindtap="showLocation">
          <view class="info-icon">ğŸ“</view>
          <view class="info-label">åœ°ç‚¹ï¼š</view>
          <view class="info-value location">{{carpoolDetail.location}}</view>
        </view>
        <view class="info-row">
          <view class="info-icon">ğŸ‘¥</view>
          <view class="info-label">äººæ•°ï¼š</view>
          <view class="info-value">{{carpoolDetail.currentCount}}/{{carpoolDetail.maxCount}}äºº</view>
        </view>
        <view class="info-row">
          <view class="info-icon">ğŸ’°</view>
          <view class="info-label">AAè´¹ç”¨ï¼š</view>
          <view class="info-value price">Â¥{{carpoolDetail.price}}/äºº</view>
        </view>
      </view>

      <view wx:if="{{carpoolDetail.description}}" class="description">
        <view class="desc-title">æ´»åŠ¨æè¿°</view>
        <view class="desc-content">{{carpoolDetail.description}}</view>
      </view>
    </view>

    <!-- ç»„ç»‡è€…ä¿¡æ¯ -->
    <view class="detail-card">
      <view class="organizer-header">
        <view class="section-title">ç»„ç»‡è€…</view>
        <button class="contact-btn" bindtap="contactOrganizer">è”ç³»TA</button>
      </view>
      <view class="organizer-info">
        <image class="organizer-avatar" src="{{carpoolDetail.organizer.avatar}}" mode="scaleToFill"></image>
        <view class="organizer-details">
          <view class="organizer-name">{{carpoolDetail.organizer.nickname}}</view>
          <view class="publish-time">å‘å¸ƒäº {{carpoolDetail.publishTime}}</view>
        </view>
      </view>
    </view>

    <!-- å‚ä¸è€…åˆ—è¡¨ -->
    <view class="detail-card">
      <view class="participants-header">
        <view class="section-title">å‚ä¸è€… ({{carpoolDetail.participants.length}}äºº)</view>
        <button wx:if="{{isOrganizer && carpoolDetail.participants.length > 0}}" 
                class="manage-btn" 
                bindtap="showParticipantManagement">ç®¡ç†</button>
      </view>
      <view class="participants-list">
        <view class="participant {{isOrganizer ? 'with-actions' : ''}}" wx:for="{{carpoolDetail.participants}}" wx:key="id">
          <image class="participant-avatar" src="{{item.avatar}}" mode="scaleToFill"></image>
          <view class="participant-info">
            <view class="participant-name">{{item.nickname}}</view>
            <view class="join-time">{{item.joinTime}}</view>
            <view wx:if="{{isOrganizer && item.hasContacted}}" class="contact-status">å·²è”ç³»</view>
          </view>
          <view wx:if="{{isOrganizer}}" class="participant-actions">
            <button class="contact-participant-btn" 
                    data-user-id="{{item.userId}}" 
                    data-nickname="{{item.nickname}}"
                    bindtap="contactParticipant">è”ç³»</button>
            <button class="remove-participant-btn" 
                    data-user-id="{{item.userId}}" 
                    data-nickname="{{item.nickname}}"
                    bindtap="removeParticipant">ç§»é™¤</button>
          </view>
        </view>
        <!-- ç©ºä½å±•ç¤º -->
        <view wx:for="{{carpoolDetail.maxCount - carpoolDetail.participants.length}}" wx:key="*this" class="participant empty-slot">
          <view class="empty-avatar">?</view>
          <view class="empty-text">ç­‰å¾…ä¸­</view>
        </view>
      </view>
    </view>

    <!-- æ³¨æ„äº‹é¡¹ -->
    <view wx:if="{{carpoolDetail.notes}}" class="detail-card">
      <view class="notes-header">
        <view class="section-title">æ³¨æ„äº‹é¡¹</view>
      </view>
      <view class="notes-content">{{carpoolDetail.notes}}</view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <!-- æ™®é€šç”¨æˆ·æ“ä½œ -->
      <view wx:if="{{!isOrganizer}}" class="user-actions">
        <button wx:if="{{!isParticipant && carpoolDetail.status === 'æ‹›å‹Ÿä¸­'}}" 
                class="join-btn" 
                bindtap="joinCarpool">
          ç«‹å³å‚ä¸
        </button>
        <button wx:elif="{{isParticipant}}" 
                class="quit-btn" 
                bindtap="quitCarpool">
                      é€€å‡ºæ‹¼å±€
        </button>
        <button wx:else 
                class="disabled-btn" 
                disabled>
          {{carpoolDetail.status}}
        </button>
      </view>

      <!-- ç»„ç»‡è€…æ“ä½œ -->
      <view wx:else class="organizer-actions">
        <button class="edit-btn">ç¼–è¾‘ä¿¡æ¯</button>
        <button class="participants-management-btn" bindtap="showParticipantManagement">ç®¡ç†å‚ä¸è€…</button>
        <button class="cancel-btn">å–æ¶ˆæ‹¼å±€</button>
      </view>
    </view>
  </view>

  <!-- ç»„ç»‡è€…è”ç³»æ–¹å¼å¼¹çª— -->
  <view wx:if="{{showOrganizerQR}}" class="qr-modal" bindtap="hideOrganizerQR">
    <view class="qr-content" catchtap="{{true}}">
      <view class="qr-header">
        <view class="qr-title">è”ç³»ç»„ç»‡è€…</view>
        <button class="close-btn" bindtap="hideOrganizerQR">âœ•</button>
      </view>
      
      <view class="qr-body">
        <view class="qr-user-info">
          <image class="qr-avatar" src="{{carpoolDetail.organizer.avatar}}" mode="scaleToFill"></image>
          <view class="qr-name">{{carpoolDetail.organizer.nickname}}</view>
          <view class="qr-tip">ç»„ç»‡è€…è”ç³»æ–¹å¼</view>
        </view>
        
        <view class="contact-info">
          <view wx:if="{{organizerWechatId}}" class="info-item">
            <text class="info-label">å¾®ä¿¡å·ï¼š</text>
            <text class="info-value">{{organizerWechatId}}</text>
          </view>
          <view wx:else class="info-item">
            <text class="no-wechat">ç»„ç»‡è€…æš‚æœªè®¾ç½®å¾®ä¿¡å·</text>
            <text class="contact-tip">å»ºè®®é€šè¿‡å°ç¨‹åºå†…æ¶ˆæ¯è”ç³»</text>
          </view>
          
          <view class="contact-guide">
            <view class="guide-item">ğŸ’¬ å¤åˆ¶å¾®ä¿¡å·åˆ°å¾®ä¿¡ä¸­æœç´¢æ·»åŠ </view>
            <view class="guide-item">ğŸ“± æˆ–é€šè¿‡å°ç¨‹åºå†…æ¶ˆæ¯åŠŸèƒ½è”ç³»</view>
          </view>
        </view>
        
        <view class="qr-actions">
          <button wx:if="{{organizerWechatId}}" class="copy-btn" bindtap="copyOrganizerWechat">å¤åˆ¶å¾®ä¿¡å·</button>
          <button class="message-btn" bindtap="sendMessageToOrganizer">å‘é€æ¶ˆæ¯</button>
        </view>
      </view>
    </view>
  </view>

  <!-- å‚ä¸è€…ç®¡ç†å¼¹çª— -->
  <view wx:if="{{showParticipantManagement}}" class="management-modal" bindtap="hideParticipantManagement">
    <view class="management-content" catchtap="{{true}}">
      <view class="management-header">
        <view class="management-title">å‚ä¸è€…ç®¡ç†</view>
        <button class="close-btn" bindtap="hideParticipantManagement">âœ•</button>
      </view>
      
      <view class="management-body">
        <view class="participants-management-list">
          <view class="management-participant" wx:for="{{detailedParticipants}}" wx:key="userId">
            <view class="participant-info-row">
              <image class="participant-avatar" src="{{item.avatarUrl}}" mode="scaleToFill"></image>
              <view class="participant-details">
                <view class="participant-name">{{item.nickname}}</view>
                <view class="join-time">åŠ å…¥æ—¶é—´ï¼š{{item.joinTime}}</view>
                <view wx:if="{{item.wechatId}}" class="wechat-info">å¾®ä¿¡å·ï¼š{{item.wechatId}}</view>
                <view wx:if="{{item.hasContacted}}" class="contact-status contacted">
                  å·²è”ç³» Â· {{item.lastContactTime}}
                </view>
                <view wx:else class="contact-status not-contacted">æœªè”ç³»</view>
              </view>
            </view>
            
            <view class="participant-management-actions">
              <button class="contact-btn" 
                      data-user-id="{{item.userId}}" 
                      data-nickname="{{item.nickname}}"
                      bindtap="contactParticipantDetailed">
                {{item.hasContacted ? 'å†æ¬¡è”ç³»' : 'è”ç³»TA'}}
              </button>
              <button class="remove-btn" 
                      data-user-id="{{item.userId}}" 
                      data-nickname="{{item.nickname}}"
                      bindtap="removeParticipantDetailed">ç§»é™¤</button>
            </view>
          </view>
        </view>
        
        <view wx:if="{{detailedParticipants.length === 0}}" class="no-participants">
          <view class="no-participants-text">æš‚æ— å‚ä¸è€…</view>
        </view>
      </view>
    </view>
  </view>

  <!-- è”ç³»å‚ä¸è€…äºŒç»´ç å¼¹çª— -->
  <view wx:if="{{showParticipantQR}}" class="qr-modal" bindtap="hideParticipantQR">
    <view class="qr-content" catchtap="{{true}}">
      <view class="qr-header">
        <view class="qr-title">å‚ä¸è€…è”ç³»æ–¹å¼</view>
        <button class="close-btn" bindtap="hideParticipantQR">âœ•</button>
      </view>
      
      <view class="qr-body">
        <view class="qr-user-info">
          <image class="qr-avatar" src="{{selectedParticipant.avatarUrl}}" mode="scaleToFill"></image>
          <view class="qr-name">{{selectedParticipant.nickname}}</view>
          <view class="qr-tip">å‚ä¸è€…è”ç³»ä¿¡æ¯</view>
        </view>
        
        <view class="contact-info">
          <view wx:if="{{selectedParticipant.wechatId}}" class="info-item">
            <text class="info-label">å¾®ä¿¡å·ï¼š</text>
            <text class="info-value">{{selectedParticipant.wechatId}}</text>
            <button class="copy-btn" bindtap="copyParticipantWechat">å¤åˆ¶</button>
          </view>
          <view wx:else class="info-item">
            <text class="no-wechat">è¯¥ç”¨æˆ·æš‚æœªè®¾ç½®å¾®ä¿¡å·</text>
          </view>
        </view>
        
        <view class="qr-actions">
          <button wx:if="{{selectedParticipant.wechatId}}" class="copy-btn" bindtap="copyParticipantWechat">å¤åˆ¶å¾®ä¿¡å·</button>
          <button class="contact-record-btn" bindtap="markAsContacted">æ ‡è®°å·²è”ç³»</button>
        </view>
      </view>
    </view>
  </view>
</view>