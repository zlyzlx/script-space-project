<!--pages/carpool-detail/carpool-detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- æ‹¼è½¦è¯¦æƒ… -->
  <view wx:else class="carpool-detail">
    <!-- æ´»åŠ¨ä¿¡æ¯å¡ç‰‡ -->
    <view class="detail-card">
      <view class="card-header">
        <view class="activity-name">{{carpoolDetail.activityName}}</view>
        <view class="status {{carpoolDetail.status === 'æ‹›å‹Ÿä¸­' ? 'recruiting' : 'full'}}">
          {{carpoolDetail.status}}
        </view>
      </view>

      <view class="activity-info">
        <view class="info-row">
          <view class="info-icon">ğŸ“…</view>
          <view class="info-label">æ—¶é—´ï¼š</view>
          <view class="info-value">{{carpoolDetail.date}} {{carpoolDetail.time}}</view>
        </view>
        <view class="info-row" bindtap="showLocation">
          <view class="info-icon">ğŸ“</view>
          <view class="info-label">åœ°ç‚¹ï¼š</view>
          <view class="info-value location">{{carpoolDetail.location}}</view>
        </view>
        <view class="info-row">
          <view class="info-icon">ğŸ‘¥</view>
          <view class="info-label">äººæ•°ï¼š</view>
          <view class="info-value">{{carpoolDetail.currentCount}}/{{carpoolDetail.maxCount}}äºº</view>
        </view>
        <view class="info-row">
          <view class="info-icon">ğŸ’°</view>
          <view class="info-label">è´¹ç”¨ï¼š</view>
          <view class="info-value price">Â¥{{carpoolDetail.price}}/äºº</view>
        </view>
      </view>

      <view wx:if="{{carpoolDetail.description}}" class="description">
        <view class="desc-title">æ´»åŠ¨æè¿°</view>
        <view class="desc-content">{{carpoolDetail.description}}</view>
      </view>
    </view>

    <!-- ç»„ç»‡è€…ä¿¡æ¯ -->
    <view class="detail-card">
      <view class="organizer-header">
        <view class="section-title">ç»„ç»‡è€…</view>
        <button class="contact-btn" bindtap="contactOrganizer">è”ç³»TA</button>
      </view>
      <view class="organizer-info">
        <image class="organizer-avatar" src="{{carpoolDetail.organizer.avatar}}" mode="scaleToFill"></image>
        <view class="organizer-details">
          <view class="organizer-name">{{carpoolDetail.organizer.nickname}}</view>
          <view class="publish-time">å‘å¸ƒäº {{carpoolDetail.publishTime}}</view>
        </view>
      </view>
    </view>

    <!-- å‚ä¸è€…åˆ—è¡¨ -->
    <view class="detail-card">
      <view class="section-title">å‚ä¸è€… ({{carpoolDetail.participants.length}}äºº)</view>
      <view class="participants-list">
        <view class="participant" wx:for="{{carpoolDetail.participants}}" wx:key="id">
          <image class="participant-avatar" src="{{item.avatar}}" mode="scaleToFill"></image>
          <view class="participant-name">{{item.nickname}}</view>
          <view class="join-time">{{item.joinTime}}</view>
        </view>
        <!-- ç©ºä½å±•ç¤º -->
        <view wx:for="{{carpoolDetail.maxCount - carpoolDetail.participants.length}}" wx:key="*this" class="participant empty-slot">
          <view class="empty-avatar">?</view>
          <view class="empty-text">ç­‰å¾…ä¸­</view>
        </view>
      </view>
    </view>

    <!-- æ³¨æ„äº‹é¡¹ -->
    <view wx:if="{{carpoolDetail.notes}}" class="detail-card">
      <view class="section-title">æ³¨æ„äº‹é¡¹</view>
      <view class="notes-content">{{carpoolDetail.notes}}</view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <!-- æ™®é€šç”¨æˆ·æ“ä½œ -->
      <view wx:if="{{!isOrganizer}}" class="user-actions">
        <button wx:if="{{!isParticipant && carpoolDetail.status === 'æ‹›å‹Ÿä¸­'}}" 
                class="join-btn" 
                bindtap="joinCarpool">
          ç«‹å³å‚ä¸
        </button>
        <button wx:elif="{{isParticipant}}" 
                class="quit-btn" 
                bindtap="quitCarpool">
          é€€å‡ºæ‹¼è½¦
        </button>
        <button wx:else 
                class="disabled-btn" 
                disabled>
          {{carpoolDetail.status}}
        </button>
      </view>

      <!-- ç»„ç»‡è€…æ“ä½œ -->
      <view wx:else class="organizer-actions">
        <button class="edit-btn">ç¼–è¾‘ä¿¡æ¯</button>
        <button class="cancel-btn">å–æ¶ˆæ‹¼è½¦</button>
      </view>
    </view>
  </view>

  <!-- ç»„ç»‡è€…å¾®ä¿¡äºŒç»´ç å¼¹çª— -->
  <view wx:if="{{showOrganizerQR}}" class="qr-modal" bindtap="hideOrganizerQR">
    <view class="qr-content" catchtap="{{true}}">
      <view class="qr-header">
        <view class="qr-title">ç»„ç»‡è€…å¾®ä¿¡äºŒç»´ç </view>
        <button class="close-btn" bindtap="hideOrganizerQR">âœ•</button>
      </view>
      
      <view class="qr-body">
        <view class="qr-user-info">
          <image class="qr-avatar" src="{{carpoolDetail.organizer.avatar}}" mode="scaleToFill"></image>
          <view class="qr-name">{{carpoolDetail.organizer.nickname}}</view>
          <view class="qr-tip">æ‰«æäºŒç»´ç ï¼Œæ·»åŠ ç»„ç»‡è€…ä¸ºå¥½å‹</view>
        </view>
        
        <view class="qr-code-container">
          <image wx:if="{{organizerQRCode}}" class="qr-code" src="{{organizerQRCode}}" mode="aspectFit"></image>
          <view wx:else class="qr-loading">è·å–ä¸­...</view>
        </view>
        
        <view class="qr-actions">
          <button class="save-btn" bindtap="saveOrganizerQRToAlbum">ä¿å­˜åˆ°ç›¸å†Œ</button>
        </view>
      </view>
    </view>
  </view>
</view>