# 剧本杀拼车小程序部署指南

## 前提条件

1. **微信开发者账号**
   - 已注册微信小程序开发者账号
   - 已获得小程序 AppID

2. **开发工具**
   - 微信开发者工具（最新版本）
   - Node.js 环境（推荐 v14+）

## 部署步骤

### 1. 云开发环境设置

1. 在微信开发者工具中打开项目
2. 点击工具栏中的"云开发"按钮
3. 创建云开发环境（如果还没有）
4. 记录环境 ID，用于后续配置

### 2. 数据库初始化

1. 在云开发控制台中，进入"数据库"页面
2. 运行 `database/init.js` 中的初始化脚本
3. 创建以下集合：
   - `carpools` - 拼车信息
   - `carpool_participants` - 拼车参与者
   - `users` - 用户信息

### 3. 云函数部署

按以下顺序部署云函数：

#### 基础功能云函数
```bash
# 拼车相关
- carpool-list      # 获取拼车列表
- carpool-detail    # 获取拼车详情  
- carpool-create    # 创建拼车
- carpool-update    # 更新拼车信息
- carpool-join      # 参与拼车
- carpool-quit      # 退出拼车
```

#### 用户功能云函数
```bash
# 用户相关
- user-info         # 获取用户信息和统计数据
- user-update       # 更新用户信息（昵称、头像等）
- user-carpools     # 获取用户发布的拼车列表
- user-rides        # 获取用户参与的拼车列表
```

#### 部署命令
在微信开发者工具中：
1. 右键点击 `cloudfunctions` 文件夹
2. 选择"同步云函数列表"
3. 对每个云函数文件夹右键选择"上传并部署"

### 4. 小程序配置

1. 更新 `app.js` 中的云开发环境 ID：
```javascript
wx.cloud.init({
  env: 'your-env-id' // 替换为你的环境 ID
})
```

2. 在小程序管理后台配置服务器域名（如果需要）

### 5. 权限配置

在云开发控制台设置数据库权限：
- `carpools`: 所有用户可读，仅创建者可写
- `carpool_participants`: 所有用户可读，仅参与者可写
- `users`: 仅创建者可读写

### 6. 测试部署

1. 在开发者工具中预览小程序
2. 测试以下核心功能：
   - 用户登录和信息展示
   - 拼车列表查看
   - 拼车详情查看
   - 创建拼车
   - 参与/退出拼车
   - 个人中心数据展示

### 7. 发布上线

1. 在开发者工具中点击"上传"
2. 在小程序管理后台提交审核
3. 审核通过后发布

## 环境要求

- **云开发环境**: 基础版或以上
- **数据库**: 2GB 存储空间
- **云函数**: 基础配额
- **云存储**: 5GB（可选，用于头像等文件）

## 常见问题

### 1. 云函数调用失败
- 检查环境 ID 是否正确
- 确认云函数已正确部署
- 查看云函数日志排查错误

### 2. 数据库权限问题
- 检查数据库安全规则设置
- 确认用户已正确登录

### 3. 用户信息获取失败
- 确认已部署 `user-info` 和 `user-update` 云函数
- 检查用户授权状态
- 查看控制台错误信息

### 4. 默认头像不显示
- 检查 `utils/util.js` 中的头像处理函数
- 确认 SVG 格式支持
- 可考虑上传默认头像到云存储

## 性能优化

1. **数据库索引**: 已在初始化脚本中配置关键索引
2. **云函数缓存**: 考虑对频繁查询的数据添加缓存
3. **图片优化**: 头像等图片建议压缩后上传

## 安全配置

1. **数据库安全规则**: 确保用户只能访问自己的数据
2. **云函数权限**: 验证用户身份后再执行敏感操作
3. **输入验证**: 对用户输入进行严格验证

## 监控和日志

1. 在云开发控制台查看：
   - 云函数调用统计
   - 数据库访问日志
   - 错误日志和异常

2. 建议设置告警规则监控关键指标

## 技术支持

- 微信开发者社区: https://developers.weixin.qq.com/community/
- 云开发文档: https://developers.weixin.qq.com/miniprogram/dev/wxcloud/
- 小程序开发文档: https://developers.weixin.qq.com/miniprogram/dev/framework/

---

**注意**: 部署前请仔细阅读微信小程序和云开发的相关政策，确保应用符合平台规范。 